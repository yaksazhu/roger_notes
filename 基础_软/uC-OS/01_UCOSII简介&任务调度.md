uC/OS II是一个:
* 可以基于ROM运行的
* 可裁减的
* 抢占式
* 实时多任务内核

# 1. uC/OS II体系结构
![](https://github.com/yaksazhu/roger_notes/blob/master/PICs/uC-OSII体系结构图_2017-04-20.png)

uC/OS II的移植，只需要修改三个文件即可：
* os_cpu.h: 进行数据类型的定义，以及处理器相关代码和几个函数原型
* os_cpu_a.asm: 需要汇编完成的一些函数，主要就是任务切换函数
* os_cpu.c: 定义一些用户HOOK函数

# 2. 定时器
定时器的作用是为uC/OS II提供系统时钟节拍(实现任务切换和任务延时等功能)
一般uC/OS II的系统时钟节拍为1ms~100ms
利用STM32F4的SYSTICK定时器来提供时钟节拍

# 3. 任务
uC/OS II早期版本只支持64个任务，但是从2.80版本开始，支持任务数提高到255个
uC/OS II保留了最高4个优先级和最低4个优先级的总共8个任务，用于拓展使用
但实际上，uC/OS II一般只占用了最低2个优先级(用于空闲任务&统计任务)
## 3.1 uC/OS任务的一般格式
```C
void MyTask (void *pdata)
{
	//任务准备工作…
	While(1)
	{
		//任务 MyTask 实体代码;
		OSTimeDlyHMSM(x,x,x,x);//调用任务延时函数，释放CPU控制权，
	}
}
```
## 3.2 任务的5种状态
1. 睡眠状态: 没有被配备任务控制块或被剥夺了任务控制块(任务创建之前, 或任务被删除后的状态)
2. 就绪状态: 配备了任务控制块且在任务就绪表中进行了就绪登记(但该任务的优先级比正在运行的任务优先级低，还暂时不能运行)
3. 运行状态: 获得了CPU的使用权
4. 等待状态: (阻塞)正在运行的任务, 因为需要等待一段时间or需要等待一个事件发生再运行 (把CPU的使用权让给了别的任务)
5. 中断服务状态: (挂起)正在运行的任务响应了中断申请 (被中止运行, 而去执行中断服务程序)
下图是剔除了睡眠态的"任务状态转换图", 因为睡眠态的转换就是靠create和del. 可见转换关系还是比较简单的.
![](https://github.com/yaksazhu/roger_notes/blob/master/PICs/uC-OSII任务状态转换图_2017-04-20.png)
注:
<font color=blue>
* 优先级是任务的"身份证号", 任务控制块OS_TCB是"身份证"
* 睡眠态, 是任务create前, 或del后的状态
* "中断"只能从"运行"来, 到"运行"去
* "运行"能转为"等待", 但"等待"不能直接转为"运行", 只能先转为"就绪"
* 能进入"运行"状态的, 只有"就绪"&"中断"
* uC/OS是一个可剥夺型的内核，中断服务子程序运行之后，系统会进行一次任务调度去运行优先级别最高的就绪任务(并不一定接着运行被中断的任务)
</font>

# 4. 几个uC/OS相关的概念
## 4.1 任务优先级
每个任务都有唯一的一个优先级, 数值小者优先级高
## 4.2 任务堆栈
就是存储器中的连续存储空间, 任务切换和响应中断时保存CPU寄存器中的内容
在创建任务的时候，任务堆栈是任务创建的一个重要入口参数
## 4.3 任务控制块OS_TCB
每个任务管理块有3个最重要的参数：
1. 任务函数指针；
2. 任务堆栈指针；
3. 任务优先级
任务控制块就是任务在系统里面的身份证
（uC/OS通过优先级识别任务）
## 4.4 任务就绪表
就是用来记录系统中所有处于就绪状态的任务
它是一个位图，系统中每个任务都在这个位图中占据一个位，该位（1或0）就表示任务是否处于就绪状态。
## 4.5 任务调度器
一是在任务就绪表中查找优先级最高的就绪任务
二是实现任务的切换。

# 5. 源码文件结构
* UCOSII-CORE: 是uC/OS的核心源码，我们不需要做任何变动。
* UCOSII-PORT: 是我们移植uC/OS要修改的3个代码，这个在移植的时候完成。
* UCOSII-CONFIG: 是uC/OS的配置部分，主要由用户根据自己的需要对uC/OS进行裁剪或其他设置。
